<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickleball Tournament</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Pickleball Tournament</h1>
        <nav>
            <ul>
                <li><a href="register.html">Register</a></li>
                <li><a href="index.html">Tournament</a></li>
                <li><a href="ranking.html">Ranking</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section>
            <h2 id="roundTitle">Current Tournament Bracket</h2>
            <div id="tournamentBracket">
                <!-- Турнирная сетка будет отображаться здесь -->
            </div>
        </section>
        <section id="finalResults" style="display:none;">
            <h2>Final Tournament Results</h2>
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Результаты будут добавлены сюда -->
                </tbody>
            </table>
        </section>
    </main>
    <footer>
        <p>&copy; 2024 Pickleball Tournament</p>
    </footer>

    <script>
        const predefinedPlayers = [
            'Alice', 'Bob', 'Charlie', 'Dave', 'Eve', 'Frank',
            'Grace', 'Hank', 'Ivy', 'Jack', 'Karen'
        ];

        let participants = JSON.parse(localStorage.getItem('participants')) || [];
        if (participants.length > 0) {
            predefinedPlayers.push(participants[participants.length - 1].name);
        }

        let currentRound = JSON.parse(localStorage.getItem('currentRound')) || 1;
        let matchResults = JSON.parse(localStorage.getItem('matchResults')) || {};

        function saveResultsAndProceed() {
            const scores = document.querySelectorAll('.score-input');
            scores.forEach((input, index) => {
                const matchId = `round${currentRound}_match${Math.floor(index / 2)}`;
                const playerNum = index % 2 === 0 ? 'player1' : 'player2';
                if (!matchResults[matchId]) matchResults[matchId] = {};
                matchResults[matchId][playerNum] = input.value;
            });
            localStorage.setItem('matchResults', JSON.stringify(matchResults));

            if (isFinalRound()) {
                showFinalResults();
            } else {
                currentRound++;
                localStorage.setItem('currentRound', JSON.stringify(currentRound));
                renderBracket();
            }
        }

        function isFinalRound() {
            return predefinedPlayers.length / Math.pow(2, currentRound) <= 1;
        }

        function renderBracket() {
            const bracket = document.getElementById('tournamentBracket');
            const roundTitle = document.getElementById('roundTitle');
            bracket.innerHTML = '';
            roundTitle.textContent = currentRound === 3 ? 'Final' : `Round ${currentRound}`;

            let players = predefinedPlayers;
            if (currentRound > 1) {
                players = [];
                for (let i = 0; i < 6; i++) {
                    const matchId = `round${currentRound-1}_match${i}`;
                    const player1Score = matchResults[matchId]?.player1 || 0;
                    const player2Score = matchResults[matchId]?.player2 || 0;
                    const winner = player1Score == 11 ? predefinedPlayers[i * 2] : predefinedPlayers[i * 2 + 1];
                    players.push(winner);
                }
            }

            const matches = [];
            const numMatches = players.length / 2;

            for (let i = 0; i < numMatches; i++) {
                const player1 = players[i * 2];
                const player2 = players[i * 2 + 1];
                const matchId = `round${currentRound}_match${i}`;
                const player1Score = matchResults[matchId]?.player1 || '';
                const player2Score = matchResults[matchId]?.player2 || '';

                matches.push(`
                    <div class="match">
                        ${player1} <select class="score-input">
                            ${[...Array(12).keys()].map(n => `<option value="${n}" ${n == player1Score ? 'selected' : ''}>${n}</option>`).join('')}
                        </select> vs
                        ${player2} <select class="score-input">
                            ${[...Array(12).keys()].map(n => `<option value="${n}" ${n == player2Score ? 'selected' : ''}>${n}</option>`).join('')}
                        </select>
                    </div>
                `);
            }

            bracket.innerHTML = matches.join('') + `<button onclick="saveResultsAndProceed()">Next Round</button>`;
        }

        function showFinalResults() {
            const finalResultsSection = document.getElementById('finalResults');
            finalResultsSection.style.display = 'block';
            const resultsTable = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];
            resultsTable.innerHTML = '';

            for (let i = 0; i < 6; i++) {
                const matchId = `round${currentRound-1}_match${i}`;
                const player1Score = matchResults[matchId]?.player1 || 0;
                const player2Score = matchResults[matchId]?.player2 || 0;
                const winner = player1Score == 11 ? predefinedPlayers[i * 2] : predefinedPlayers[i * 2 + 1];
                const loser = player1Score != 11 ? predefinedPlayers[i * 2] : predefinedPlayers[i * 2 + 1];

                resultsTable.innerHTML += `<tr><td>${winner}</td><td>Winner</td></tr>`;
                resultsTable.innerHTML += `<tr><td>${loser}</td><td>Eliminated</td></tr>`;
            }
        }

        renderBracket();
    </script>
</body>
</html>
